// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// Authentication Models (NextAuth.js v5)
// ============================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?   // Hashed password for credentials auth

  role          Role      @default(VIEWER)
  isActive      Boolean   @default(true)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Relations
  accounts      Account[]
  sessions      Session[]
  regionAccess  UserRegionAccess[]

  @@index([email])
  @@index([role])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// User role enum
enum Role {
  ADMIN    // Full access, all regions
  MANAGER  // Can manage targets, limited by region
  VIEWER   // Read-only, limited by region
}

// User-Region access control (many-to-many)
model UserRegionAccess {
  id        String   @id @default(cuid())
  userId    String
  regionId  String

  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  region    Region   @relation(fields: [regionId], references: [id], onDelete: Cascade)

  @@unique([userId, regionId])
  @@index([userId])
  @@index([regionId])
}

// ============================================
// Core Business Models
// ============================================

model Region {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  currency    String
  timezone    String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  deals       Deal[]
  targets     Target[]
  syncLogs    SyncLog[]
  userAccess  UserRegionAccess[]

  @@index([code])
}

model Deal {
  id                   String    @id @default(cuid())
  hubspotId            String
  regionId             String

  name                 String
  amount               Float
  currency             String
  amountUsd            Float
  exchangeRate         Float

  stage                String
  stageProbability     Float
  probabilitySource    String
  forecastCategory     String?

  closeDate            DateTime
  deployTime           DateTime?
  createdAt            DateTime
  lastModifiedAt       DateTime

  ownerName            String?
  ownerEmail           String?

  // Additional deal properties
  priority             String?
  description          String?
  distributor          String?
  endUserLocation      String?
  numContacts          Int?       @default(0)

  hubspotUrl           String?
  rawData              Json?

  region               Region       @relation(fields: [regionId], references: [id])
  lineItems            LineItem[]
  contacts             DealContact[]

  @@unique([hubspotId, regionId])
  @@index([regionId])
  @@index([stage])
  @@index([closeDate])
  @@index([lastModifiedAt])
  @@index([regionId, closeDate])
}

model LineItem {
  id                   String   @id @default(cuid())
  dealId               String
  hubspotLineItemId    String

  name                 String
  description          String?
  quantity             Float
  price                Float
  amount               Float

  productId            String?

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  deal                 Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@unique([dealId, hubspotLineItemId])
  @@index([dealId])
}

model DealContact {
  id                   String   @id @default(cuid())
  dealId               String
  hubspotContactId     String

  firstName            String?
  lastName             String?
  email                String?
  jobTitle             String?
  phone                String?
  company              String?

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  deal                 Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@unique([dealId, hubspotContactId])
  @@index([dealId])
}

model Target {
  id              String   @id @default(cuid())
  regionId        String
  ownerName       String?  // null = region-level target, otherwise owner-specific

  year            Int
  quarter         Int

  amount          Float
  currency        String   @default("USD")

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?
  notes           String?

  region          Region   @relation(fields: [regionId], references: [id])

  @@unique([regionId, year, quarter, ownerName])
  @@index([year, quarter])
  @@index([ownerName])
}

model SyncLog {
  id              String   @id @default(cuid())
  regionId        String

  status          String
  startedAt       DateTime @default(now())
  completedAt     DateTime?
  duration        Int?

  dealsProcessed  Int      @default(0)
  dealsCreated    Int      @default(0)
  dealsUpdated    Int      @default(0)
  dealsFailed     Int      @default(0)

  errorMessage    String?
  errorDetails    Json?

  triggerType     String
  triggeredBy     String?

  region          Region   @relation(fields: [regionId], references: [id])

  @@index([regionId])
  @@index([startedAt])
  @@index([status])
}

model PipelineStage {
  id              String   @id @default(cuid())

  name            String   @unique  // e.g., "Initial Contact"
  code            String   @unique  // e.g., "initial_contact"
  probability     Float             // Win probability (0-100)
  displayOrder    Int               // Order in pipeline (1-9)

  isActive        Boolean  @default(true)
  isFinal         Boolean  @default(false)  // true for Closed Won/Lost
  isWon           Boolean  @default(false)  // true for Closed Won

  color           String?           // Optional color code for UI
  description     String?           // Optional description

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([displayOrder])
  @@index([isActive])
}

model ExchangeRate {
  id              String   @id @default(cuid())

  fromCurrency    String
  toCurrency      String   @default("USD")

  rate            Float
  date            DateTime

  source          String   @default("exchangerate-api")

  createdAt       DateTime @default(now())

  @@unique([fromCurrency, toCurrency, date])
  @@index([date])
}
